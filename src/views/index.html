<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
    <title>My App</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      /* Always set the map height explicitly to define the size of the div
       * element that contains the map. */
      #map {
        height: 60%;
        width: 60%;
      }
      /* Optional: Makes the sample page fill the window. */
      html,
      body {
        height: 100%;
        margin: 2%;
        padding: 0;
      }
    </style>
  </head>
  <body>
    <!-- Header Menu. Note use of headerCtrl -->
    <div class="header" ng-controller="headerCtrl">
      <!-- Header Title -->
      <h1 class="text-muted">reprograma-Meli_ProjFinal_API</h1>
    </div>

    <div id="map"></div>
    <h3>Postar Evento com Geolocalização</h3>

    <form>
      Título:<br />
      <input style="margin-bottom:10px" type="text" id="titulo" name="titulo" />
      <br />
      Descrição:<br />
      <input
        style="margin-bottom:10px"
        type="text"
        id="descricao"
        name="descricao"
      />
      <br />
      Categoria:<br />
      <input
        style="margin-bottom:10px"
        type="text"
        id="categoria"
        name="categoria"
      />
      <br />
      Status:<br />
      <input style="margin-bottom:10px" type="text" id="status" name="status" />
      <br />
      Prioridade:<br />
      <input type="text" id="prioridade" name="prioridade" />
      <p>
        Latitude: <span id="latitude" name="latitude"></span>&deg;<br />
        Longitude: <span id="longitude" name="longitude"></span>&deg;<br />
      </p>
      <input type="submit" value="Submit" />
    </form>

    <script>
      // Google Maps
      var map, infoWindow;
      async function initMap() {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: -34.397, lng: 150.644 },
          zoom: 8
        });
        infoWindow = new google.maps.InfoWindow();

        // HTML5 geolocation.
        if (navigator.geolocation) {
          navigator.geolocation.getCurrentPosition(
            async function(position) {
              var pos = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
              };
              document.getElementById("latitude").textContent = pos.lat.toFixed(
                3
              );
              document.getElementById(
                "longitude"
              ).textContent = pos.lng.toFixed(3);

              infoWindow.setPosition(pos);
              infoWindow.setContent("Minha localização");
              infoWindow.open(map);
              map.setCenter(pos);

              // //Pegando valores dos inputs
              // const titulo = document.getElementById("titulo").value;
              // const descricao = document.getElementById("descricao").value;
              // const categoria = document.getElementById("categoria").value;
              // const status = document.getElementById("status").value;
              // const prioridade = document.getElementById("prioridade").value;
              // console.log(titulo.value);

              // //Mandando Cadastro de evento
              // const data = {
              //   titulo: document.getElementById("titulo").value,
              //   descricao: descricao ,
              //   categoria: categoria,
              //   status: status,
              //   prioridade: prioridade,
              //   geolocalizacao: [pos.lat, pos.lng]
              // };

              // console.log(data)

              // const options = {
              //   method: "POST",
              //   headers: {
              //     "Content-Type": "application/json",
              //     "Access-Control-Allow-Origin": "*"
              //   },
              //   body: JSON.stringify(data)
              // };

              postEvento();
              // const jsonData = await response.json();
              // console.log(jsonData);
            },
            function() {
              handleLocationError(true, infoWindow, map.getCenter());
            }
          );
        } else {
          // Browser doesn't support Geolocation
          handleLocationError(false, infoWindow, map.getCenter());
        }
      }

      function handleLocationError(browserHasGeolocation, infoWindow, pos) {
        infoWindow.setPosition(pos);
        infoWindow.setContent(
          browserHasGeolocation
            ? "Error: The Geolocation service failed."
            : "Error: Your browser doesn't support geolocation."
        );
        infoWindow.open(map);
      }
    </script>
    <script>
      function postEvento() {
        const Form = document.querySelector("form");
        const formCalculator = Form.addEventListener("submit", event => {
          event.preventDefault();

          //Pegando valores dos inputs
          const titulo = document.getElementById("titulo").value;
          const descricao = document.getElementById("descricao").value;
          const categoria = document.getElementById("categoria").value;
          const status = document.getElementById("status").value;
          const prioridade = document.getElementById("prioridade").value;
          console.log(titulo.value);

          //Mandando Cadastro de evento
          const data = {
            titulo: titulo,
            descricao: descricao,
            categoria: categoria,
            status: status,
            prioridade: prioridade,
            geolocalizacao: [
              (document.getElementById(
                "latitude"
              ).textContent),
              (document.getElementById(
                "latitude"
              ).textContent)
            ]
          };
          console.log(data);

          const options = {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Access-Control-Allow-Origin": "*"
            },
            body: JSON.stringify(data)
          };

          const response = fetch(
            "/eventos/post/5df443ba723c8d312c564470",
            options
          );
          const jsonData = response.json();
          console.log(jsonData);
        });
      }
    </script>
    <script
      async
      defer
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCIEOuFK4m3ljAcwkCUFIVJbMNLbIBZAAg&callback=initMap"
    ></script>
  </body>
</html>
